<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>ì°¨ëŸ‰ ì‹œë®¬ë ˆì´í„°</title>
    <style>
        body { font-family: sans-serif; padding: 20px; }
        button { margin: 5px; padding: 10px 20px; }
        textarea { width: 100%; height: 300px; margin-top: 20px; }
    </style>
</head>
<body>
<h1>ì°¨ëŸ‰ ë°ì´í„° ì‹œë®¬ë ˆì´í„°</h1>
<label for="host-url">API ì„œë²„ ì£¼ì†Œ:</label>
<input type="text" id="host-url" value="http://localhost:8080" style="width: 300px;" />
<br><br>

<button id="btn-ignition-on" onclick="handleIgnitionOn()">ì‹œë™ ON</button>
<button id="btn-drive" onclick="startDriving()" disabled>ì£¼í–‰ ì‹œì‘</button>
<button id="btn-ignition-off" onclick="handleIgnitionOff()">ì‹œë™ OFF</button>
<textarea id="log" readonly></textarea>

<script>
    const vehicleId = "TEST-1234";
    let ignitionTime = null;
    let cumulativeDistance = 0;
    let gpsStatus = "A";
    let driving = false;
    let driveData = [];
    let lastLat = 37.5665;
    let lastLon = 126.9780;
    let drivingInterval = null;
    let lastShutdownData = null;

    let globalTuid = null;  // ì‹œë™ ON ~ OFF ì„¸íŠ¸ ë™ì•ˆ ìœ ì§€í•  TUID

    const commonFields = {
        tid: "A001", mid: "6", pv: "5", did: "1"
    };

    const btnIgnitionOn = document.getElementById("btn-ignition-on");
    const btnIgnitionOff = document.getElementById("btn-ignition-off");
    const btnDrive = document.getElementById("btn-drive");

    function log(msg) {
        const logArea = document.getElementById("log");
        logArea.value += `[${new Date().toLocaleTimeString()}] ${msg}\n`;
        logArea.scrollTop = logArea.scrollHeight;
    }

    function sendRequest(endpoint, body) {
        const baseUrl = document.getElementById("host-url").value || "http://localhost:8080";
        const url = `${baseUrl}${endpoint}`;

        const headers = {
            "Content-Type": "application/json; charset=utf-8",
            "Accept": "application/json; charset=utf-8",
            "Cache-Control": "no-cache",
            "Accept-Encoding": "gzip, deflate",
            "X-Timestamp": getFormattedTime(),
            "X-TUID": globalTuid ?? crypto.randomUUID(),  // ì‹œë™ ONì¼ ë•Œë§Œ ìƒˆë¡œ ìƒì„±
            "Key-Version": "1.0",
            "Token": "test-token"
        };

        log(`POST to ${url}:\n${JSON.stringify(body, null, 2)}`);
        fetch(url, {
            method: "POST",
            headers: headers,
            body: JSON.stringify(body)
        }).then(res => log(`ì‘ë‹µ ìƒíƒœ: ${res.status}`));
    }

    function getFormattedTime() {
        const now = new Date();
        const year = now.getFullYear();
        const month = String(now.getMonth() + 1).padStart(2, '0'); // ì›”ì€ 0ë¶€í„° ì‹œì‘í•˜ë¯€ë¡œ 1ì„ ë”í•¨
        const day = String(now.getDate()).padStart(2, '0');
        const hours = String(now.getHours()).padStart(2, '0');
        const minutes = String(now.getMinutes()).padStart(2, '0');
        const seconds = String(now.getSeconds()).padStart(2, '0');
        const milliseconds = String(now.getMilliseconds()).padStart(3, '0'); // ë°€ë¦¬ì´ˆëŠ” 000ê¹Œì§€ ì¶œë ¥í•´ì•¼ í•©ë‹ˆë‹¤.

        const ts = `${year}-${month}-${day} ${hours}:${minutes}:${seconds}.${milliseconds}`;
        console.log("add Timestamp to header : " + ts);
        return ts;
    }

    function formatTime(date) {
        return date.getFullYear().toString().padStart(4, '0') +
            (date.getMonth() + 1).toString().padStart(2, '0') +
            date.getDate().toString().padStart(2, '0') +
            date.getHours().toString().padStart(2, '0') +
            date.getMinutes().toString().padStart(2, '0') +
            date.getSeconds().toString().padStart(2, '0');
    }

    function updateButtonStates() {
        btnIgnitionOn.disabled = ignitionTime !== null;
        btnDrive.disabled = ignitionTime === null || driving;
        btnIgnitionOff.disabled = ignitionTime === null;
    }

    function handleIgnitionOn() {
        const now = new Date();
        const onTime = formatTime(now);

        if (ignitionTime) {
            log("âš ï¸ ì´ë¯¸ ì‹œë™ì´ ì¼œì ¸ ìˆìŠµë‹ˆë‹¤.");
            return;
        }

        globalTuid = crypto.randomUUID(); // âœ… ìƒˆë¡œìš´ ì„¸íŠ¸ ì‹œì‘

        if (lastShutdownData) {
            const distanceFromLast = getDistance(
                lastShutdownData.lat,
                lastShutdownData.lon,
                lastLat,
                lastLon
            );

            if (distanceFromLast < 80) {
                cumulativeDistance = lastShutdownData.sum + distanceFromLast;
            } else {
                log(`ğŸŸ¡ ì‹œë™ ON ê±°ë¦¬ (${Math.round(distanceFromLast)}m)ê°€ 80m ì´ˆê³¼ë¡œ ë¬´ì‹œë¨`);
                cumulativeDistance = lastShutdownData.sum;
            }
        }

        ignitionTime = onTime;

        const payload = {
            ...commonFields,
            mdn: vehicleId,
            onTime: ignitionTime,
            offTime: '',
            gcd: gpsStatus,
            lat: lastLat.toFixed(6),
            lon: lastLon.toFixed(6),
            sum: Math.floor(cumulativeDistance)
        };

        sendRequest("/api/ignition/on", payload);
        updateButtonStates();
        log("ğŸ”‘ ì‹œë™ ON");
    }

    function handleIgnitionOff() {
        const now = new Date();
        const offTime = formatTime(now);

        if (!ignitionTime) {
            log("âš ï¸ ì‹œë™ì´ êº¼ì ¸ ìˆìŠµë‹ˆë‹¤. OFF ìš”ì²­ ë¶ˆê°€.");
            return;
        }

        if (driving) {
            clearInterval(drivingInterval);
            driving = false;

            if (driveData.length > 0) {
                const body = {
                    ...commonFields,
                    mdn: vehicleId,
                    oTime: formatTime(now).slice(0, 12),
                    cCnt: driveData.length,
                    cList: driveData
                };
                sendRequest("/api/cycle-log", body);
                driveData = [];
            }

            lastShutdownData = {
                lat: lastLat,
                lon: lastLon,
                sum: cumulativeDistance
            };

            log("ì£¼í–‰ ì¢…ë£Œ (ì‹œë™ OFFë¡œ ì¢…ë£Œ)");
        }

        const payload = {
            ...commonFields,
            mdn: vehicleId,
            onTime: ignitionTime,
            offTime: offTime,
            gcd: gpsStatus,
            lat: lastLat.toFixed(6),
            lon: lastLon.toFixed(6),
            sum: Math.floor(cumulativeDistance)
        };

        sendRequest("/api/ignition/off", payload);
        ignitionTime = null;
        globalTuid = null;  // âœ… ì„¸íŠ¸ ì¢…ë£Œ
        updateButtonStates();
        log("ğŸ›‘ ì‹œë™ OFF");
    }



    function startDriving() {
        if (!ignitionTime) {
            log("âš ï¸ ì‹œë™ì´ ë¨¼ì € ì¼œì ¸ì•¼ í•©ë‹ˆë‹¤.");
            return;
        }

        if (driving) {
            log("âš ï¸ ì´ë¯¸ ì£¼í–‰ ì¤‘ì…ë‹ˆë‹¤.");
            return;
        }

        driving = true;
        driveData = [];
        updateButtonStates();
        log("ğŸš— ì£¼í–‰ ì‹œì‘");

        drivingInterval = setInterval(() => {
            const now = new Date();
            const sec = now.getSeconds().toString().padStart(2, '0');

            lastLat += 0.0001;
            lastLon += 0.0001;

            const spd = Math.floor(Math.random() * 20) + 30;
            const distance = (spd * 1000 / 3600);
            cumulativeDistance += distance;

            driveData.push({
                sec: sec,
                gcd: gpsStatus,
                lat: lastLat.toFixed(6),
                lon: lastLon.toFixed(6),
                spd: spd,
                sum: Math.floor(cumulativeDistance)
            });

            if (driveData.length === 60) {
                const body = {
                    ...commonFields,
                    mdn: vehicleId,
                    oTime: formatTime(now).slice(0, 12),
                    cCnt: 60,
                    cList: driveData
                };
                sendRequest("/api/cycle-log", body);
                driveData = [];
            }
        }, 1000);
    }

    function getDistance(lat1, lon1, lat2, lon2) {
        const R = 6371000;
        const toRad = x => x * Math.PI / 180;
        const dLat = toRad(lat2 - lat1);
        const dLon = toRad(lon2 - lon1);
        const a = Math.sin(dLat / 2) ** 2 + Math.cos(toRad(lat1)) * Math.cos(toRad(lat2)) * Math.sin(dLon / 2) ** 2;
        return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
    }

    updateButtonStates(); // ì´ˆê¸° ë²„íŠ¼ ìƒíƒœ ì„¤ì •
</script>

</body>
</html>
